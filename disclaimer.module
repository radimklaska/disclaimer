<?php
// $Id$
/**
 * @file
 * Create and show disclaimer for your site.
 * Visitors need js enabled and accept cookie
 *
 * Module by: Mog
 * Mailto: tech@arthura.fr
 *
 */

/**
 * Implements hook_menu().
 */
function disclaimer_menu() {
  $items = array();
  // Disclaimer page
  $items['disclaimer'] = array(
    'page callback' => 'disclaimer_get_content',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  // Discliamer no theme page
  $items['disclaimer/print'] = array(
    'page callback' => 'disclaimer_get_content',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  // Disclaimer module settings
  $items['admin/config/system/disclaimer'] = array(
    'title' => 'Disclaimer',
    'description' => 'Administer Disclaimer settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('disclaimer_admin_settings'),
    'access callback' => 'user_access',
    'access arguments' => array('administer disclaimer settings'),
    'file' => 'disclaimer.admin.inc',
  );
  return $items;
}

/**
 * Implements hook_init().
 */
function disclaimer_init() {
  if (disclaimer_show()) {
    // add modal library
    drupal_add_library('disclaimer', variable_get('disclaimer_modal', 'nyroModal'));
    // cookie settings
    drupal_add_js(
      array('disclaimer' => array(
        'cookie_path' => variable_get('disclaimer_cookie_path', '/'),
        'cookie_expires' => variable_get('disclaimer_cookie_expires', ''),
        'cookie_domain' => variable_get('disclaimer_cookie_domain', ''),
        ),
      ),
      'setting'
    );
    drupal_add_js(drupal_get_path('module', 'disclaimer') . '/disclaimer.js', array('scope' => 'footer'));
    drupal_add_js(
      disclaimer_get_js(),
      array(
        'type' => 'inline',
        'scope' => 'header',
      )
    );
  }
}

function disclaimer_show() {
  global $user;
  $show = FALSE;
  // check cookie
  if (!isset($_COOKIE[variable_get('disclaimer_cookie_name', 'disclaimerShow')])) {
    // config and user access
    if ((!user_access('bypass disclaimer') || (variable_get('disclaimer_logged', 1) == 1 && $user->uid)) && (_disclaimer_visibility() == 1)) {
      $show = TRUE;
    }
  }
  return $show;
}

/**
 * Implements hook_permission().
 */
function disclaimer_permission() {
  return array(
    'administer disclaimer settings' => array(
      'title' => t('administer disclaimer settings'),
      'description' => t('Full administration access, only for admin.'),
    ),
    'bypass disclaimer' => array(
      'title' => t('bypass disclaimer'),
      'description' => t('If you want to hide disclaimer by roles.'),
    ),
  );
}

/**
 * Implements hook_page_alter().
 */
function disclaimer_page_alter(&$page) {
  global $user;
  $output = FALSE;
  if (!user_access('bypass disclaimer') || (variable_get('disclaimer_logged', 1) == 1 && $user->uid)) {
    if (variable_get('disclaimer_modal', 'nyroModal') == 'jqModal') {
      $output = '<div id="disclaimer" style="display:none;" class="jqmWindow">&nbsp</div>';
    }
  }
  if ($output) {
    $page['page_bottom']['disclaimer']= array(
      '#type' => 'markup',
      '#markup' => $output,
    );
  }
}

/**
 * Generate disclaimer content
 */
function disclaimer_get_content($js = TRUE) {
  $action_type = variable_get('disclaimer_action_type', 'text');
  $exit_url = variable_get('disclaimer_exit_url', 'http://www.google.com');
  $enter_url = variable_get('disclaimer_enter_url', '');
  $nid = variable_get('disclaimer_node', 0);
  $nid_footer = variable_get('disclaimer_node_footer', '');
  $age = variable_get('disclaimer_age_form', 0);
  $age_limit = variable_get('disclaimer_age_limit', 18);
  $modal = variable_get('disclaimer_modal', 'nyroModal');
  $enter = variable_get('disclaimer_enter_txt', t('ENTER'));
  $exit = variable_get('disclaimer_exit_txt', t('EXIT'));
  if ($action_type == 'image') {
    // enter
    $variables['alt'] = $variables['title'] = variable_get('disclaimer_enter_img_alt', t('ENTER'));
    $file = file_load(variable_get('disclaimer_enter_img'));
    if ($file) {
      $variables['path'] = $file->uri;
      $variables['attributes'] = '';
      $enter = theme_image($variables);
    }
    else {
      $enter = variable_get('disclaimer_enter_txt', t('ENTER'));
    }
    // exit
    $variables['alt'] = $variables['title'] = variable_get('disclaimer_exit_img_alt', t('EXIT'));
    if ($file) {
      $file = file_load(variable_get('disclaimer_exit_img'));
      $variables['path'] = $file->uri;
      $variables['attributes'] = '';
      $exit = theme_image($variables);
    }
    else {
      $exit = variable_get('disclaimer_exit_txt', t('EXIT'));
    }
  }
  else {
    $enter = variable_get('disclaimer_enter_txt', t('ENTER'));
    $exit = variable_get('disclaimer_exit_txt', t('EXIT'));
  }
  if ($age == 1) {
    $age_form = drupal_get_form('disclaimer_age_form');
    $rows[] = array(
        array('data' => $age_form, 'align' => 'center', 'colspan' => '2')
      );
    $script = "CheckAge('" . variable_get('disclaimer_cookie_name', 'disclaimerShow') . "', " . $age_limit . ", '" . $exit_url . "', '" . $modal . "');";
  }
  else {
    $script = 'WriteCookie(\'' . variable_get('disclaimer_cookie_name', 'disclaimerShow') . '\', \'1\');';
    if ($modal == 'nyroModal') {
      $script .= 'jQuery.nyroModalRemove();';
    }
    else {
      $script .= 'jQuery(\'#disclaimer\').jqmHide();';
    }
  }
  // enter redirect or not
  if ($enter_url) {
    $js ? $attributes = array('attributes' => array('onclick' => $script)): $attributes = array();
    $enter = l($enter, $enter_url, $attributes + array('html' => TRUE));
  }
  else {
    $js ? $attributes = 'href="javascript:void(0);" onclick="' . $script . '"': $attributes = 'href=""';
    $enter = '<a ' . $attributes . '>' . $enter . '</a>';
  }
  $exit = l($exit, $exit_url, array('html' => TRUE));

  $rows[] = array(
    array('data' => $enter, 'align' => 'center'),
    array('data' => $exit, 'align' => 'center'),
  );
  // is node top selected ?
  if ($nid == 0) {
    $content = variable_get('disclaimer_content', array());
    $output = check_markup($content['value'], $content['format']);
  }
  else {
    $node = node_view(node_load($nid));
    $output = drupal_render($node['body']);
  }
  // button output
  $output .= theme('table', array('header' => array(), 'rows' => $rows));
  // is node footer selected ?
  if ($nid_footer == 0) {
    $content = variable_get('disclaimer_content_footer', array());
    $output .= check_markup($content['value'], $content['format']);
  }
  else {
    $node = node_view(node_load($nid_footer));
    $output .= drupal_render($node['body']);
  }
  if (arg(1) && (arg(1) == 'print')) {
    // no theme
    print $output;
    exit;
  }
  else {
    return $output;
  }
}

/**
 * Generate js function
 */
function disclaimer_get_js() {
  $cookie_path = variable_get('disclaimer_cookie_path', '/');
  $cookie_expires = variable_get('disclaimer_cookie_expires', '');
  $cookie_domain = variable_get('disclaimer_cookie_domain', '');
  $modal = variable_get('disclaimer_modal', 'nyroModal');
  if ($modal == 'nyroModal') {
    $debug = variable_get('disclaimer_debug', 'false');
    $width = variable_get('disclaimer_width', 400);
    $height = variable_get('disclaimer_height', 300);
    $padding = variable_get('disclaimer_padding', 20);
    $bgcolor = variable_get('disclaimer_bgcolor', '000000');
  }
  else {
    $overlay = variable_get('disclaimer_jqmodal_overlay', 90);
  }
  $js[] = 'jQuery(document).ready(function(){';
  if ($modal == 'nyroModal') {
    $js[] = 'jQuery.nyroModalManual({modal:true, url:\'' . url('disclaimer/print') . '\', minWidth:' . $width . ', minHeight:' . $height . ', padding:' . $padding . ', debug:' . $debug . ', bgColor:\'#' . $bgcolor . '\'});';
  }
  else {
    $js[] = 'jQuery(\'#disclaimer\').jqm({ajax:\'' . base_path() . '/disclaimer\', overlay:' . $overlay . ', modal:true}).jqmShow();';
  }
  $js[] = '});';
  $output = implode("\n", $js);
  return $output;
}

/**
 * Calculate visibility of disclaimer if set
 * function copy from block.module, thanks for the original code.
 * @return bolean
 */
function _disclaimer_visibility() {
  $visibility = variable_get('disclaimer_visibility', 0);
  $pages = variable_get('disclaimer_pages', "admin/*\nuser");
  // Convert path to lowercase. This allows comparison of the same path
  // with different case. Ex: /Page, /page, /PAGE.
  $pages = drupal_strtolower($pages);
  if ($visibility < 2) {
    // Convert the Drupal path to lowercase
    $path = drupal_strtolower(drupal_get_path_alias($_GET['q']));
    // Compare the lowercase internal and lowercase path alias (if any).
    $page_match = drupal_match_path($path, $pages);
    if ($path != $_GET['q']) {
      $page_match = $page_match || drupal_match_path($_GET['q'], $pages);
    }
    // When $visibility has a value of 0,
    // the disclaimer is displayed on all pages except those listed in $pages.
    // When set to 1, it is displayed only on those
    // pages listed in $pages.
    $page_match = !($visibility xor $page_match);
  }
  elseif (module_exists('php')) {
    $page_match = php_eval($pages);
  }
  else {
    $page_match = FALSE;
  }
  return $page_match;
}

/**
 * function to set age form on disclaimer
 * @return array an array of forms
 */
function disclaimer_age_form($form) {
  $form['disclaimer_age'] = array(
    '#type' => 'date',
    '#title' => t('Date of Birth'),
    '#description' => t('You must be at least @age years old to visit @site.', array('@age' => variable_get('disclaimer_age_limit', 18), '@site' => variable_get('site_name', ''))),
  );
  return $form;
}

/**
 * Implements hook_library().
 */
function disclaimer_library() {
  // nyroModal.
  $libraries['nyroModal'] = array(
    'title' => 'nyroModal',
    'website' => 'http://plugins.jquery.com/project/nyroModal',
    'version' => '1.6.1',
    'js' => array(
      drupal_get_path('module', 'disclaimer') . '/nyroModal/js/jquery.nyroModal.js' => array(),
    ),
    'css' => array(
      drupal_get_path('module', 'disclaimer') . '/nyroModal/styles/nyroModal.css' => array(),
    ),
  );
  // nyroModal.
  $libraries['jqModal'] = array(
    'title' => 'jqModal',
    'website' => 'http://dev.iceburg.net/jquery/jqModal/',
    'version' => '2009.03.01 +r14',
    'js' => array(
      drupal_get_path('module', 'disclaimer') . '/jqModal/jqModal.js' => array(),
    ),
    'css' => array(
      drupal_get_path('module', 'disclaimer') . '/jqModal/jqModal.css' => array(),
    ),
  );
  return $libraries;
}
